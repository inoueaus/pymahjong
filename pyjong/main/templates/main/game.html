{% extends "base.html" %}

{% block content %}


{% if session['in_room'] == True %}




</head>
<div class="container py-3">
<h1>PyJong雀荘</h1>
<h5 class="pt-1">ルーム名： {{ session['room'] }}</h5>
</div>

<!-- MahJong -->
<div class="container py-2">
<h3><strong>Game</strong></h3>
<div class="float-end"　id="gamestart-btn">
  <button type="button" id="gamestart" class="btn btn-outline-warning">ゲームをスタート</button>
</div>
</div>

<div id="inputpanel">


{% if session['player_id'] == 1 %}

<div id="player1" class="container px-3">
<div class="" id="p1-display">
<img id="p1-guiimg" src="" alt="" class="img-fluid rounded mx-auto d-block">
<div class="" id="p1-input">
<h5 id="tehai-text" class="pt-2">手配：</h5>
<div id="p1-mochihai-container" class="pt-1">
<img id="p1-mochihai" src="" alt="" class="rounded-top d-block mx-auto">
</div>
<div class="container pb-1">
<img id="p1-tehaiimg" src="" alt="" class="rounded mx-auto d-block" usemap="#player1-tehaimap">
<map name="player1-tehaimap" >
  <area id="hai0" class="tehaimap" shape="rect" coords="2,2,32,52">
  <area id="hai1" class="tehaimap" shape="rect" coords="32,2,62,52">
  <area id="hai2" class="tehaimap" shape="rect" coords="62,2,92,52">
  <area id="hai3" class="tehaimap"  shape="rect" coords="92,2,122,52">
  <area id="hai4" class="tehaimap" shape="rect" coords="122,2,152,52">
  <area id="hai5" class="tehaimap" shape="rect" coords="152,2,182,52">
  <area id="hai6" class="tehaimap" shape="rect" coords="182,2,212,52">
  <area id="hai7" class="tehaimap"  shape="rect" coords="212,2,242,52">
  <area id="hai8" class="tehaimap" shape="rect" coords="242,2,272,52">
  <area id="hai9" class="tehaimap" shape="rect" coords="272,2,302,52">
  <area id="hai10" class="tehaimap" shape="rect" coords="302,2,332,52">
  <area id="hai11" class="tehaimap"  shape="rect" coords="332,2,362,52">
  <area id="hai12" class="tehaimap" shape="rect" coords="362,2,392,52">
  <area id="hai13" class="tehaimap" shape="rect" coords="392,2,422,52">
</map>
</div>
</div>
</div>

<div class="container pt-2">
  <textarea class="form-control" style="height: 100px" id="game" rows="20"></textarea>
</div>

<div id="gamebuttons" class="btn-toolbar pt-1 pb-5" role="toolbar">
  <div id="yesnobuttons" class="btn-group" role="group" style="width:100%" >
    <button id="p1-yes" type="button" class="btn btn-outline-secondary">Yes</button>
    <button id="p1-no" type="button" class="btn btn-outline-secondary">No</button>
  </div>
</div>
</div>





{% else %}
<div id="player2" class="container px-5">
<div class="" id="p2-display">
<img id="p2-guiimg" src="" alt="" class="img-fluid rounded mx-auto d-block">
<div class="" id="p1-input">
<h5 id="tehai-text" class="pt-2">手配：</h5>
<div id="p2-mochihai-container" class="pt-1">
<img id="p2-mochihai" src="" alt="" class="rounded-top d-block mx-auto">
</div>
<div class="container pb-1">
<img id="p2-tehaiimg" src="" alt="" class="rounded mx-auto d-block" usemap="#player1-tehaimap">
<map name="player1-tehaimap" >
  <area id="hai0" class="tehaimap" shape="rect" coords="2,2,32,52">
  <area id="hai1" class="tehaimap" shape="rect" coords="32,2,62,52">
  <area id="hai2" class="tehaimap" shape="rect" coords="62,2,92,52">
  <area id="hai3" class="tehaimap" shape="rect" coords="92,2,122,52">
  <area id="hai4" class="tehaimap" shape="rect" coords="122,2,152,52">
  <area id="hai5" class="tehaimap" shape="rect" coords="152,2,182,52">
  <area id="hai6" class="tehaimap" shape="rect" coords="182,2,212,52">
  <area id="hai7" class="tehaimap"  shape="rect" coords="212,2,242,52">
  <area id="hai8" class="tehaimap" shape="rect" coords="242,2,272,52">
  <area id="hai9" class="tehaimap" shape="rect" coords="272,2,302,52">
  <area id="hai10" class="tehaimap" shape="rect" coords="302,2,332,52">
  <area id="hai11" class="tehaimap"  shape="rect" coords="332,2,362,52">
  <area id="hai12" class="tehaimap" shape="rect" coords="362,2,392,52">
  <area id="hai13" class="tehaimap" shape="rect" coords="392,2,422,52">
</map>
</div>
</div>
</div>

<div class="container pt-2">
  <textarea class="form-control" style="height: 100px" id="game"></textarea>
</div>

<div id="gamebuttons" class="btn-toolbar pt-1 pb-5" role="toolbar">
  <div id="yesnobuttons" class="btn-group" role="group" style="width:100%" >
    <button id="p2-yes" type="button" class="btn btn-outline-secondary">Yes</button>
    <button id="p2-no" type="button" class="btn btn-outline-secondary">No</button>
  </div>
</div>
</div>
{% endif %}
</div>










{% if session['players'] == 2 %}
<!-- Chat box -->
<div class="container pb-5">
        <div class="form-floating px-2">
          <div class="pt-2">
            <textarea class="form-control" style="height: 300px" id="chat" rows="20"></textarea>
          </div>
          <div class="pt-2 pb-2">
            <input class="form-control" id="text" placeholder="エンターキーを押して送信">
          </div>
          <div class="float-end">
            <button type="button" onclick="leave_room();" class="btn btn-outline-warning">ルームを出る</button>
          </div>
        </div>
</div>
{% else %}

{% endif %}

<div class="pb-5">

</div>

<!-- Room creation -->
{% else %}

{% if session['has_friends'] %}

<div class="container py-3">
  <h1 class="mx-3">友達を誘って麻雀を始めましょう！</h1>
  <form class="" action="" method="POST">
    <div class="form-floating px-5">

  {{form.hidden_tag()}}
  <div class="py-2">
  {{form.select_friend.label(class="form-label")}}
  {{form.select_friend(class="form-control")}}
</div>
<div class="py-2">
  {{form.room_name.label(class="form-label")}}
  {{form.room_name(class="form-control")}}

</div>
  {{form.submit(class="btn btn-secondary")}}

</div>
  </form>
  <div class="container px-5">
  <p class="text-muted pt-3">もしくは</p>
  <div class="pt-1">
    <form class="" action="" method="POST">
      {{solo_form.hidden_tag()}}
      {{solo_form.submit(class="btn btn-outline-secondary")}}
    </form>
  </div>
  </div>
</div>

{% else %}

<div class="container">
  <h1 class="pt-3">友達を誘ってチャットを始めましょう！</h1>

  <form class="" action="" method="POST">
    <div class="form-floating px-5">

  {{form.hidden_tag()}}
  <div class="py-2">
  {{form.select_friend.label(class="form-label")}}
  {{form.select_friend(class="form-select")}}
</div>
<div class="py-2">
  {{form.room_name.label(class="form-label")}}
  {{form.room_name(class="form-control")}}

</div>
  {{form.submit(class="btn btn-outline-primary")}}

</div>
  </form>
  <div class="container px-5">
  <p class="text-muted pt-2">もしくは</p>
  <div class="py-2">
    <form class="" action="" method="POST">
      {{solo_form.hidden_tag()}}
      {{solo_form.submit(class="btn btn-outline-secondary")}}
    </form>
  </div>
  </div>
</div>


{% endif %}
{% endif %}







<!-- Chat room/game　script  -->
          <script type="text/javascript" charset="utf-8">
              var socket;
              // $('#p1-input').hide()
              // $('#gamebuttons').hide()

              $(document).ready(function(){
                  socket = io.connect('http://' + document.domain + ':' + location.port + '/main/game');
                  socket.on('connect', function() {
                      socket.emit('joined', {});
                      console.log('connected');
                  });
                  {% if session['players'] == 2 %}
                  socket.on('status', function(data) {
                      $('#chat').val($('#chat').val() + '・' + data.msg + '\n');
                      $('#chat').scrollTop($('#chat')[0].scrollHeight);
                      console.log('status func')
                  });
                  socket.on('message', function(data) {
                      $('#chat').val($('#chat').val() + data.msg + '\n');
                      $('#chat').scrollTop($('#chat')[0].scrollHeight);
                      console.log('message func')
                  });
                  socket.on('new-game', function() {
                      $('#inputpanel').show()
                      $('#player2').show()
                      $('#gamebuttons').show()

                  });
                  {% endif %}
                  socket.on('gameupdate', function(data) {
                      $('#game').val($('#game').val() + data.msg + '\n');
                      // $('#game').css("overflow", "hidden");
                      $('#game').scrollTop($('#game')[0].scrollHeight);
                      console.log('game message func')
                  });


                  {% if session['player_id'] == 1 %}
                  socket.on('p1-board_gui', function(data) {
                    var arrayBufferView = new Uint8Array( data.img );
                    var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL( blob );
                    var image_id = document.getElementById('p1-guiimg');
                    image_id.src = imageUrl;
                    console.log('board image received')
                  });
                  socket.on('p1-tehaiimg', function(data) {
                    var arrayBufferView = new Uint8Array( data.img );
                    var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL( blob );
                    var image_id = document.getElementById('p1-tehaiimg');
                    image_id.src = imageUrl;
                    console.log('tehai image received')
                  });
                  socket.on('p1-mochihai', function(data) {
                    var arrayBufferView = new Uint8Array( data.img );
                    var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL( blob );
                    var image_id = document.getElementById('p1-mochihai');
                    image_id.src = imageUrl;
                    $('#p1-mochihai-container').show();
                    console.log('mochihai image received')
                  });
                  {% else %}
                  socket.on('p2-guiimg', function(data) {
                    var arrayBufferView = new Uint8Array( data.img );
                    var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL( blob );
                    var image_id = document.getElementById('p2-guiimg');
                    image_id.src = imageUrl;
                    console.log('board image received')
                  });
                  socket.on('p2-tehaiimg', function(data) {
                    var arrayBufferView = new Uint8Array( data.img );
                    var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL( blob );
                    var image_id = document.getElementById('p2-tehaiimg');
                    image_id.src = imageUrl;
                    console.log('tehai image received')
                  });
                  socket.on('p2-mochihai', function(data) {
                    var arrayBufferView = new Uint8Array( data.img );
                    var blob = new Blob( [ arrayBufferView ], { type: "image/jpeg" } );
                    var urlCreator = window.URL || window.webkitURL;
                    var imageUrl = urlCreator.createObjectURL( blob );
                    var image_id = document.getElementById('p2-mochihai');
                    image_id.src = imageUrl;
                    $('#p2-mochihai-container').show();
                    console.log('mochihai image received')
                  });
                  {% endif %}
                  $('#text').keypress(function(e) {
                      var code = e.keyCode || e.which;
                      console.log('keypress')
                      if (code == 13) {
                          text = $('#text').val();
                          $('#text').val('');
                          socket.emit('text', {msg: text});
                          console.log('emit text',text)

                      }
                  });
                  // $('#gamecontrol').keypress(function(e) {
                  //     var code = e.keyCode || e.which;
                  //     console.log('keypress')
                  //     if (code == 13) {
                  //         text = $('#gamecontrol').val();
                  //         $('#gamecontrol').val('');
                  //         socket.emit('gamecontrol', {msg: text});
                  //         console.log('emit text',text)
                  //
                  //     }
                  // });
                  $('#startsolo').on('click', function() {
                    socket.emit('startsolo');
                    console.log('startsolo')
                  });
                  $('#gamestart').on('click', function() {
                    socket.emit('start');
                    $('#gamestart').hide();
                    $('#p1-input').show()
                    $('#gamebuttons').show()
                    console.log('gamestart')
                  });
                  $('#p1-yes').on('click', function() {
                    socket.emit('gamecontrol', {msg: 'Y'});
                    $('#p1-mochihai-container').hide();
                    console.log('yes button')
                  });
                  $('#p1-no').on('click', function() {
                    socket.emit('gamecontrol', {msg: 'N'});
                    $('#p1-mochihai-container').hide();
                    console.log('no button')
                  });
                  $('#p2-yes').on('click', function() {
                    socket.emit('gamecontrol', {msg: 'Y'});
                    $('#p2-mochihai-container').hide();
                    console.log('yes button')
                  });
                  $('#p2-no').on('click', function() {
                    socket.emit('gamecontrol', {msg: 'N'});
                    $('#p2-mochihai-container').hide();
                    console.log('no button')
                  });
                  $('#hai0').on('click', function() {
                    socket.emit('gamecontrol', {msg: '0'});
                    console.log('hai0')
                  });
                  $('#hai1').on('click', function() {
                    socket.emit('gamecontrol', {msg: '1'});
                    console.log('hai1')
                  });
                  $('#hai2').on('click', function() {
                    socket.emit('gamecontrol', {msg: '2'});
                    console.log('hai2')
                  });
                  $('#hai3').on('click', function() {
                    socket.emit('gamecontrol', {msg: '3'});
                    console.log('hai3')
                  });
                  $('#hai4').on('click', function() {
                    socket.emit('gamecontrol', {msg: '4'});
                    console.log('hai4')
                  });
                  $('#hai5').on('click', function() {
                    socket.emit('gamecontrol', {msg: '5'});
                    console.log('hai5')
                  });
                  $('#hai6').on('click', function() {
                    socket.emit('gamecontrol', {msg: '6'});
                    console.log('hai6')
                  });
                  $('#hai7').on('click', function() {
                    socket.emit('gamecontrol', {msg: '7'});
                    console.log('hai7')
                  });
                  $('#hai8').on('click', function() {
                    socket.emit('gamecontrol', {msg: '8'});
                    console.log('hai8')
                  });
                  $('#hai9').on('click', function() {
                    socket.emit('gamecontrol', {msg: '9'});
                    console.log('hai9')
                  });
                  $('#hai10').on('click', function() {
                    socket.emit('gamecontrol', {msg: '10'});
                    console.log('hai10')
                  });
                  $('#hai11').on('click', function() {
                    socket.emit('gamecontrol', {msg: '11'});
                    console.log('hai11')
                  });
                  $('#hai12').on('click', function() {
                    socket.emit('gamecontrol', {msg: '12'});
                    console.log('hai12')
                  });
                  $('#hai13').on('click', function() {
                    socket.emit('gamecontrol', {msg: '13'});
                    console.log('hai13')
                  });


              });
              function hai0Function() {
                socket.emit('gamecontrol', {msg: '0'});
                console.log('hai0')
              }
              function leave_room() {
                  socket.emit('left', {}, function() {
                      socket.disconnect();

                      // go back to the friends page
                      window.location.href = "{{ url_for('main.friends') }}";
                  });
              }

          </script>


{% endblock %}
